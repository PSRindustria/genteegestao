<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Banco de Talentos - PSR</title>
    <meta name="robots" content="noindex, nofollow">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üëî</text></svg>">
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --psr-blue: #003366;
            --psr-accent: #00c2ff;
            --bg-gray: #f0f2f5;
            --white: #ffffff;
            --text: #333;
            --border: #e0e0e0;
            --success: #28a745;
            --danger: #dc3545;
        }

        * { box-sizing: border-box; outline: none; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--bg-gray); margin: 0; color: var(--text); padding-bottom: 50px; }

        /* --- LOGIN & LOAD --- */
        .full-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; flex-direction: column; z-index: 999; }
        #login-screen { background: linear-gradient(135deg, var(--psr-blue) 0%, #001a33 100%); color: white; }
        #loading-screen { background: rgba(255,255,255,0.95); z-index: 1000; }
        #access-denied { background: #fee2e2; color: #991b1b; display: none; }
        #app-screen { display: none; }

        .auth-card { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); text-align: center; width: 350px; color: #333; }
        .btn-google { width: 100%; padding: 12px; border: 1px solid #ccc; background: white; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 20px; transition: 0.3s; }
        .btn-google:hover { background: #f8f9fa; }

        /* --- LAYOUT --- */
        header { background: var(--psr-blue); color: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .logo h1 { margin: 0; font-size: 1.2rem; }
        .logo span { font-size: 0.8rem; opacity: 0.8; }
        
        .main-container { max-width: 1400px; margin: 20px auto; padding: 0 20px; display: grid; grid-template-columns: 280px 1fr; gap: 20px; }

        /* --- SIDEBAR FILTROS --- */
        .sidebar { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); height: fit-content; position: sticky; top: 20px; }
        .sidebar h3 { margin-top: 0; color: var(--psr-blue); font-size: 1rem; border-bottom: 2px solid var(--bg-gray); padding-bottom: 10px; }
        
        .filter-group { margin-bottom: 15px; }
        .filter-group label { display: block; font-size: 0.8rem; font-weight: 600; color: #666; margin-bottom: 5px; }
        .filter-input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-family: inherit; font-size: 0.9rem; }
        .filter-input:focus { border-color: var(--psr-blue); }
        
        .btn-filter { width: 100%; padding: 10px; background: var(--psr-blue); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; margin-top: 10px; }
        .btn-clear { background: #e0e0e0; color: #333; margin-top: 10px; }

        /* --- MAIN CONTENT --- */
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: white; padding: 15px; border-radius: 10px; }
        .stats { font-size: 0.9rem; color: #666; }
        .stats strong { color: var(--psr-blue); font-size: 1.1rem; }

        .btn-add { background: var(--success); color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .btn-add:hover { background: #218838; }

        /* --- TABLE --- */
        .table-container { background: white; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); overflow-x: auto; min-height: 400px; }
        table { width: 100%; border-collapse: collapse; min-width: 900px; }
        th { background: #f8f9fa; text-align: left; padding: 15px; font-size: 0.8rem; text-transform: uppercase; color: #666; border-bottom: 2px solid #eee; position: sticky; top: 0; }
        td { padding: 15px; border-bottom: 1px solid #eee; font-size: 0.9rem; vertical-align: middle; }
        tr:hover { background: #f0f7ff; }

        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
        .badge-area { background: #e3f2fd; color: #0d47a1; }
        .badge-prod { background: #e8f5e9; color: #1b5e20; }
        .badge-adm { background: #fff3e0; color: #e65100; }

        .actions-cell { display: flex; gap: 10px; }
        .btn-icon { background: none; border: none; cursor: pointer; font-size: 1.1rem; color: #999; transition: 0.2s; }
        .btn-icon:hover { color: var(--psr-blue); transform: scale(1.1); }
        .btn-icon.delete:hover { color: var(--danger); }

        /* --- MODAL --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-box { background: white; width: 90%; max-width: 800px; border-radius: 12px; padding: 30px; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .modal-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .full-width { grid-column: span 2; }
        
        .form-group label { display: block; font-size: 0.8rem; font-weight: 600; margin-bottom: 5px; color: #555; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-family: inherit; }
        
        /* Mobile */
        @media (max-width: 768px) {
            .main-container { grid-template-columns: 1fr; }
            .sidebar { position: static; margin-bottom: 20px; }
            .modal-grid { grid-template-columns: 1fr; }
            .full-width { grid-column: span 1; }
        }
    </style>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, get, child, update, push, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // Configura√ß√£o do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyD4lN6iyKpdstb99vosxEDDaEn1QFXLCXI",
            authDomain: "agenda-portal-2d149.firebaseapp.com",
            databaseURL: "https://agenda-portal-2d149-default-rtdb.firebaseio.com",
            projectId: "agenda-portal-2d149",
            storageBucket: "agenda-portal-2d149.firebasestorage.app",
            messagingSenderId: "172797946066",
            appId: "1:172797946066:web:b3f50853717477661c650b"
        };

        const ALLOWED_EMAILS = [
            'marketingpsrimpressao@gmail.com',
            'rohsantos1@gmail.com',
            'thaisportoaraujo6@gmail.com',
            'milenessfranca@gmail.com'
        ];

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const provider = new GoogleAuthProvider();

        let allCandidates = [];
        let currentEditId = null;

        // --- AUTH ---
        onAuthStateChanged(auth, (user) => {
            document.getElementById('loading-screen').style.display = 'none';
            if (user && ALLOWED_EMAILS.includes(user.email.toLowerCase())) {
                document.getElementById('user-email').innerText = user.email;
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-screen').style.display = 'block';
                carregarCandidatos();
            } else if (user) {
                document.getElementById('denied-email').innerText = user.email;
                document.getElementById('access-denied').style.display = 'flex';
                document.getElementById('login-screen').style.display = 'none';
            } else {
                document.getElementById('login-screen').style.display = 'flex';
            }
        });

        window.login = () => signInWithPopup(auth, provider);
        window.logout = () => signOut(auth).then(() => location.reload());

        // --- CRUD CANDIDATOS ---

        async function carregarCandidatos() {
            const tableBody = document.getElementById('table-body');
            tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px;">Atualizando lista do Firebase...</td></tr>';
            
            try {
                // Busca direta no n√≥ 'candidatos'
                const snapshot = await get(child(ref(db), 'candidatos'));
                allCandidates = [];
                if (snapshot.exists()) {
                    snapshot.forEach(childSnapshot => {
                        allCandidates.push({
                            id: childSnapshot.key,
                            ...childSnapshot.val()
                        });
                    });
                }
                aplicarFiltros(); // Renderiza a tabela
            } catch (error) {
                console.error(error);
                alert("Erro ao carregar candidatos: " + error.message);
            }
        }

        window.salvarCandidato = async () => {
            const data = {
                nome: document.getElementById('c_nome').value,
                email: document.getElementById('c_email').value,
                nascimento: document.getElementById('c_nascimento').value,
                cpf: document.getElementById('c_cpf').value,
                telefone: document.getElementById('c_telefone').value,
                whatsapp: document.getElementById('c_whatsapp').value,
                sexo: document.getElementById('c_sexo').value,
                estado_civil: document.getElementById('c_civil').value,
                area: document.getElementById('c_area').value,
                cep: document.getElementById('c_cep').value,
                endereco: document.getElementById('c_endereco').value,
                bairro: document.getElementById('c_bairro').value,
                cidade: document.getElementById('c_cidade').value,
                link_curriculo: document.getElementById('c_link').value,
                // Se for edi√ß√£o, mant√©m a data original, sen√£o cria nova
                data_cadastro: currentEditId ? (allCandidates.find(c => c.id === currentEditId).data_cadastro) : new Date().toISOString()
            };

            if (!data.nome || !data.area) return alert("Nome e √Årea s√£o obrigat√≥rios!");

            try {
                if (currentEditId) {
                    await update(ref(db, `candidatos/${currentEditId}`), data);
                    alert("Candidato atualizado com sucesso!");
                } else {
                    await push(ref(db, 'candidatos'), data);
                    alert("Candidato adicionado ao Banco de Talentos!");
                }
                closeModal();
                carregarCandidatos();
            } catch (e) {
                alert("Erro ao salvar: " + e.message);
            }
        };

        window.deletarCandidato = async (id) => {
            if (confirm("ATEN√á√ÉO: Isso excluir√° permanentemente este candidato do banco de dados.\n\nDeseja continuar?")) {
                await remove(ref(db, `candidatos/${id}`));
                carregarCandidatos();
            }
        };

        window.editarCandidato = (id) => {
            const c = allCandidates.find(x => x.id === id);
            if (!c) return;
            
            currentEditId = id;
            document.getElementById('modalTitle').innerText = "Editar Candidato";
            
            // Preencher campos
            const fields = ['nome', 'email', 'nascimento', 'cpf', 'telefone', 'whatsapp', 'sexo', 'civil', 'area', 'cep', 'endereco', 'bairro', 'cidade', 'link'];
            fields.forEach(f => {
                const key = f === 'civil' ? 'estado_civil' : (f === 'link' ? 'link_curriculo' : f);
                document.getElementById(`c_${f}`).value = c[key] || '';
            });
            
            openModal();
        };

        // --- FILTROS & RENDERIZA√á√ÉO ---

        window.aplicarFiltros = () => {
            const fNome = document.getElementById('f_nome').value.toLowerCase();
            const fArea = document.getElementById('f_area').value;
            const fCidade = document.getElementById('f_cidade').value.toLowerCase();
            const fIdadeMin = parseInt(document.getElementById('f_idade_min').value) || 0;
            const fIdadeMax = parseInt(document.getElementById('f_idade_max').value) || 100;

            const filtered = allCandidates.filter(c => {
                // C√°lculo Idade
                let age = 0;
                if(c.nascimento) {
                    const birth = new Date(c.nascimento);
                    if(!isNaN(birth)) {
                        age = new Date().getFullYear() - birth.getFullYear();
                    }
                }

                const matchNome = (c.nome || '').toLowerCase().includes(fNome);
                const matchArea = fArea === "" || c.area === fArea;
                const matchCidade = c.cidade ? c.cidade.toLowerCase().includes(fCidade) : true;
                const matchIdade = age >= fIdadeMin && age <= fIdadeMax;

                return matchNome && matchArea && matchCidade && matchIdade;
            });

            renderTable(filtered);
        };

        function renderTable(list) {
            const tbody = document.getElementById('table-body');
            document.getElementById('total-count').innerText = list.length;
            tbody.innerHTML = "";

            if (list.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:30px; color:#888;">Nenhum candidato encontrado com estes filtros.</td></tr>';
                return;
            }

            list.forEach(c => {
                // Formata√ß√£o de Idade
                let idade = 'N/D';
                if(c.nascimento) {
                    const birth = new Date(c.nascimento);
                    if(!isNaN(birth)) idade = (new Date().getFullYear() - birth.getFullYear()) + ' anos';
                }
                
                // Badge de √Årea
                let badgeClass = 'badge-area';
                if (c.area === 'Produ√ß√£o') badgeClass = 'badge-prod';
                if (c.area === 'Administrativo' || c.area === 'Financeiro' || c.area === 'RH') badgeClass = 'badge-adm';

                // Link OneDrive
                let btnLink = `<span style="color:#eee; cursor:default" title="Sem curr√≠culo"><i class="fas fa-link"></i></span>`;
                if (c.link_curriculo && c.link_curriculo.length > 5) {
                    btnLink = `<a href="${c.link_curriculo}" target="_blank" class="btn-icon" style="color:#0078d4" title="Abrir Curr√≠culo (OneDrive/Drive)"><i class="fas fa-cloud"></i></a>`;
                }

                // WhatsApp (Remove caracteres n√£o num√©ricos)
                const wpp = c.whatsapp ? c.whatsapp.replace(/\D/g, '') : '';
                const btnWpp = wpp ? `<a href="https://wa.me/55${wpp}" target="_blank" class="btn-icon" style="color:#25d366" title="Chamar no WhatsApp"><i class="fab fa-whatsapp"></i></a>` : `<span class="btn-icon" style="color:#eee; cursor:default"><i class="fab fa-whatsapp"></i></span>`;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <div style="font-weight:600; color:var(--psr-blue)">${c.nome}</div>
                        <div style="font-size:0.75rem; color:#888">${c.email || ''}</div>
                    </td>
                    <td><span class="badge ${badgeClass}">${c.area}</span></td>
                    <td>${idade}</td>
                    <td>${c.cidade || '-'} / ${c.bairro || '-'}</td>
                    <td>${c.telefone || '-'}</td>
                    <td class="actions-cell">
                        ${btnWpp}
                        ${btnLink}
                        <button onclick="editarCandidato('${c.id}')" class="btn-icon" title="Editar"><i class="fas fa-edit"></i></button>
                        <button onclick="deletarCandidato('${c.id}')" class="btn-icon delete" title="Excluir"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- UI ---
        window.openModal = () => {
            document.getElementById('modalCandidato').style.display = 'flex';
        }
        window.closeModal = () => {
            document.getElementById('modalCandidato').style.display = 'none';
            currentEditId = null;
            document.getElementById('formCandidato').reset();
            document.getElementById('modalTitle').innerText = "Novo Candidato";
        }
        window.limparFiltros = () => {
            document.getElementById('f_nome').value = '';
            document.getElementById('f_area').value = '';
            document.getElementById('f_cidade').value = '';
            document.getElementById('f_idade_min').value = '';
            document.getElementById('f_idade_max').value = '';
            aplicarFiltros();
        }

    </script>
</head>
<body>

    <div id="loading-screen" class="full-screen">
        <i class="fas fa-spinner fa-spin fa-3x" style="color:var(--psr-blue)"></i>
        <p style="margin-top:15px">Acessando Banco de Talentos...</p>
    </div>

    <div id="login-screen" class="full-screen">
        <div class="auth-card">
            <h2>PSR Talentos</h2>
            <p>Acesso Restrito ao RH</p>
            <button onclick="login()" class="btn-google">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20"> Entrar com Google
            </button>
        </div>
    </div>

    <div id="access-denied" class="full-screen">
        <div class="auth-card" style="border-top: 5px solid red;">
            <h2 style="color:red">Acesso Negado</h2>
            <p>O e-mail <b id="denied-email"></b> n√£o tem permiss√£o.</p>
            <button onclick="logout()" class="btn-google" style="border:1px solid red; color:red">Sair</button>
        </div>
    </div>

    <div id="app-screen">
        <header>
            <div class="logo">
                <h1>Gest√£o de Candidatos</h1>
                <span>PSR Impress√£o</span>
            </div>
            <div style="display:flex; align-items:center; gap:15px">
                <span id="user-email" style="font-size:0.8rem">...</span>
                <button onclick="logout()" style="background:none; border:none; color:white; cursor:pointer"><i class="fas fa-sign-out-alt"></i> Sair</button>
            </div>
        </header>

        <div class="main-container">
            <aside class="sidebar">
                <h3><i class="fas fa-filter"></i> Filtragem</h3>
                
                <div class="filter-group">
                    <label>Nome do Candidato</label>
                    <input type="text" id="f_nome" class="filter-input" placeholder="Buscar por nome...">
                </div>

                <div class="filter-group">
                    <label>√Årea Pretendida</label>
                    <select id="f_area" class="filter-input">
                        <option value="">Todas</option>
                        <option value="Produ√ß√£o">Produ√ß√£o</option>
                        <option value="Financeiro">Financeiro</option>
                        <option value="RH">RH</option>
                        <option value="Administra√ß√£o">Administra√ß√£o</option>
                        <option value="Comercial">Comercial</option>
                        <option value="Log√≠stica">Log√≠stica</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label>Cidade</label>
                    <input type="text" id="f_cidade" class="filter-input" placeholder="Ex: Paracambi">
                </div>

                <div class="filter-group">
                    <label>Idade (Min - Max)</label>
                    <div style="display:flex; gap:5px">
                        <input type="number" id="f_idade_min" class="filter-input" placeholder="18">
                        <input type="number" id="f_idade_max" class="filter-input" placeholder="60">
                    </div>
                </div>

                <button class="btn-filter" onclick="aplicarFiltros()">Aplicar Filtros</button>
                <button class="btn-filter btn-clear" onclick="limparFiltros()">Limpar</button>
            </aside>

            <main>
                <div class="top-bar">
                    <div class="stats">
                        Total de Candidatos: <strong id="total-count">0</strong>
                    </div>
                    <div style="display:flex; gap:10px">
                        <button class="btn-add" onclick="openModal()"><i class="fas fa-plus"></i> Novo Candidato</button>
                    </div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Candidato</th>
                                <th>√Årea</th>
                                <th>Idade</th>
                                <th>Local</th>
                                <th>Telefone</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="table-body">
                            </tbody>
                    </table>
                </div>
            </main>
        </div>
    </div>

    <div id="modalCandidato" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <h3 id="modalTitle" style="color:var(--psr-blue); margin:0">Novo Candidato</h3>
                <button onclick="closeModal()" style="border:none; background:none; cursor:pointer; font-size:1.2rem">&times;</button>
            </div>
            
            <form id="formCandidato" onsubmit="event.preventDefault(); salvarCandidato();">
                <div class="modal-grid">
                    <div class="form-group full-width">
                        <label>Nome Completo *</label>
                        <input type="text" id="c_nome" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="c_email">
                    </div>
                    <div class="form-group">
                        <label>Data Nascimento</label>
                        <input type="date" id="c_nascimento">
                    </div>

                    <div class="form-group">
                        <label>CPF</label>
                        <input type="text" id="c_cpf">
                    </div>
                    <div class="form-group">
                        <label>Telefone</label>
                        <input type="text" id="c_telefone">
                    </div>
                    
                    <div class="form-group">
                        <label>WhatsApp (Apenas n√∫meros)</label>
                        <input type="text" id="c_whatsapp">
                    </div>
                    <div class="form-group">
                        <label>√Årea Pretendida *</label>
                        <select id="c_area" required>
                            <option value="">Selecione...</option>
                            <option value="Produ√ß√£o">Produ√ß√£o</option>
                            <option value="Financeiro">Financeiro</option>
                            <option value="RH">RH</option>
                            <option value="Administra√ß√£o">Administra√ß√£o</option>
                            <option value="Comercial">Comercial</option>
                            <option value="Log√≠stica">Log√≠stica</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Sexo</label>
                        <select id="c_sexo">
                            <option value="">Selecione...</option>
                            <option value="Masculino">Masculino</option>
                            <option value="Feminino">Feminino</option>
                            <option value="Outro">Outro</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Estado Civil</label>
                        <input type="text" id="c_civil">
                    </div>

                    <div class="form-group full-width">
                        <label>Link do Curr√≠culo (OneDrive/Drive)</label>
                        <input type="url" id="c_link" placeholder="https://onedrive.live.com/...">
                        <small style="color:#888; font-size:0.7rem">Copie o link do arquivo no OneDrive e cole aqui.</small>
                    </div>

                    <div class="form-group">
                        <label>CEP</label>
                        <input type="text" id="c_cep">
                    </div>
                    <div class="form-group">
                        <label>Endere√ßo</label>
                        <input type="text" id="c_endereco">
                    </div>
                    <div class="form-group">
                        <label>Bairro</label>
                        <input type="text" id="c_bairro">
                    </div>
                    <div class="form-group">
                        <label>Cidade</label>
                        <input type="text" id="c_cidade">
                    </div>
                </div>

                <div style="margin-top:20px; display:flex; gap:10px; justify-content:flex-end">
                    <button type="button" onclick="closeModal()" style="padding:10px 20px; border:none; background:#eee; cursor:pointer; border-radius:6px">Cancelar</button>
                    <button type="submit" style="padding:10px 20px; border:none; background:var(--psr-blue); color:white; cursor:pointer; border-radius:6px">Salvar Candidato</button>
                </div>
            </form>
        </div>
    </div>

</body>
</html>