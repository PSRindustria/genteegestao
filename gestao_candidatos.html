<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Banco de Talentos - PSR</title>
    <meta name="robots" content="noindex, nofollow">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90' fill='%23003366'>üëî</text></svg>">
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --psr-blue: #003366;
            --psr-accent: #00c2ff;
            --bg-gray: #f0f2f5;
            --white: #ffffff;
            --text: #333;
            --border: #e0e0e0;
            --success: #28a745;
            --danger: #dc3545;
        }

        * { box-sizing: border-box; outline: none; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--bg-gray); margin: 0; color: var(--text); padding-bottom: 50px; }

        /* --- TELAS DE LOGIN & LOAD --- */
        .full-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; flex-direction: column; z-index: 999; }
        #login-screen { background: linear-gradient(135deg, var(--psr-blue) 0%, #001a33 100%); color: white; }
        #loading-screen { background: rgba(255,255,255,0.95); z-index: 1000; }
        #access-denied { background: #fee2e2; color: #991b1b; display: none; }
        #app-screen { display: none; }

        .auth-card { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); text-align: center; width: 350px; color: #333; }
        .btn-google { width: 100%; padding: 12px; border: 1px solid #ccc; background: white; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 20px; transition: 0.3s; }
        .btn-google:hover { background: #f8f9fa; }

        /* --- LAYOUT --- */
        header { background: var(--psr-blue); color: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .logo h1 { margin: 0; font-size: 1.2rem; }
        .logo span { font-size: 0.8rem; opacity: 0.8; }
        
        .main-container { max-width: 1400px; margin: 20px auto; padding: 0 20px; display: grid; grid-template-columns: 300px 1fr; gap: 20px; }

        /* --- SIDEBAR FILTROS --- */
        .sidebar { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); height: fit-content; position: sticky; top: 20px; }
        .sidebar h3 { margin-top: 0; color: var(--psr-blue); font-size: 1rem; border-bottom: 2px solid var(--bg-gray); padding-bottom: 10px; display: flex; align-items: center; gap: 8px; }
        
        .filter-group { margin-bottom: 15px; }
        .filter-group label { display: block; font-size: 0.8rem; font-weight: 600; color: #666; margin-bottom: 5px; }
        .filter-input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-family: inherit; font-size: 0.9rem; transition: 0.3s; }
        .filter-input:focus { border-color: var(--psr-blue); box-shadow: 0 0 0 3px rgba(0, 51, 102, 0.1); }
        
        .geo-group { background: #e3f2fd; padding: 10px; border-radius: 8px; border: 1px solid #bbdefb; }
        .geo-group label { color: #0d47a1; }

        .btn-filter { width: 100%; padding: 10px; background: var(--psr-blue); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; margin-top: 10px; transition: 0.2s; }
        .btn-filter:hover { background: #002244; }
        .btn-clear { background: #e0e0e0; color: #333; margin-top: 10px; }
        .btn-clear:hover { background: #d0d0d0; }

        /* --- MAIN CONTENT --- */
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: white; padding: 15px; border-radius: 10px; }
        .stats { font-size: 0.9rem; color: #666; }
        .stats strong { color: var(--psr-blue); font-size: 1.1rem; }

        .btn-add { background: var(--success); color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; transition: 0.2s; }
        .btn-add:hover { background: #218838; opacity: 0.9; }

        /* --- TABLE & SORTING --- */
        .table-container { background: white; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); overflow-x: auto; min-height: 400px; }
        table { width: 100%; border-collapse: collapse; min-width: 900px; }
        
        /* Cabe√ßalho Clic√°vel para Ordena√ß√£o */
        th { 
            background: #f8f9fa; 
            text-align: left; 
            padding: 15px; 
            font-size: 0.8rem; 
            text-transform: uppercase; 
            color: #666; 
            border-bottom: 2px solid #eee; 
            position: sticky; 
            top: 0; 
            z-index: 10; 
            cursor: pointer; /* Indica clic√°vel */
            user-select: none;
            transition: 0.2s;
        }
        th:hover { background: #e9ecef; color: var(--psr-blue); }
        th i { margin-left: 5px; opacity: 0.3; }
        th.sort-asc i, th.sort-desc i { opacity: 1; color: var(--psr-blue); }

        td { padding: 15px; border-bottom: 1px solid #eee; font-size: 0.9rem; vertical-align: middle; }
        tr:hover { background: #f0f7ff; }

        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
        .badge-area { background: #e3f2fd; color: #0d47a1; }
        .badge-prod { background: #e8f5e9; color: #1b5e20; }
        .badge-adm { background: #fff3e0; color: #e65100; }
        .badge-fin { background: #fce4ec; color: #880e4f; }
        .dist-badge { background: #f3e5f5; color: #7b1fa2; font-size: 0.7rem; margin-left: 5px; padding: 2px 5px; border-radius: 3px; }

        .actions-cell { display: flex; gap: 10px; align-items: center; } /* Corre√ß√£o do alinhamento */
        .btn-icon { background: none; border: none; cursor: pointer; font-size: 1.1rem; color: #999; transition: 0.2s; }
        .btn-icon:hover { color: var(--psr-blue); transform: scale(1.1); }
        .btn-icon.delete:hover { color: var(--danger); }

        /* --- MODAL --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-box { background: white; width: 90%; max-width: 800px; border-radius: 12px; padding: 30px; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .modal-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .full-width { grid-column: span 2; }
        
        .form-group label { display: block; font-size: 0.8rem; font-weight: 600; margin-bottom: 5px; color: #555; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-family: inherit; }
        
        @media (max-width: 768px) {
            .main-container { grid-template-columns: 1fr; }
            .sidebar { position: static; margin-bottom: 20px; }
            .modal-grid { grid-template-columns: 1fr; }
            .full-width { grid-column: span 1; }
        }
    </style>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, get, child, update, push, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // Configura√ß√£o
        const firebaseConfig = {
            apiKey: "AIzaSyD4lN6iyKpdstb99vosxEDDaEn1QFXLCXI",
            authDomain: "agenda-portal-2d149.firebaseapp.com",
            databaseURL: "https://agenda-portal-2d149-default-rtdb.firebaseio.com",
            projectId: "agenda-portal-2d149",
            storageBucket: "agenda-portal-2d149.firebasestorage.app",
            messagingSenderId: "172797946066",
            appId: "1:172797946066:web:b3f50853717477661c650b"
        };

        const ALLOWED_EMAILS = [
            'marketingpsrimpressao@gmail.com',
            'rohsantos1@gmail.com',
            'thaisportoaraujo6@gmail.com',
            'milenessfranca@gmail.com'
        ];

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const provider = new GoogleAuthProvider();

        // For√ßa a persist√™ncia do login do Firebase no Local Storage do navegador
        setPersistence(auth, browserLocalPersistence);

        let allCandidates = [];
        let filteredCandidates = [];
        let currentEditId = null;
        let sortConfig = { key: null, direction: 'asc' }; // Controle de Ordena√ß√£o

        // --- ATLAS DE COORDENADAS (Para busca por KM) ---
        const CITY_COORDS = {
            "paracambi": {lat: -22.6111, lon: -43.7125},
            "japeri": {lat: -22.6436, lon: -43.6542},
            "mendes": {lat: -22.5261, lon: -43.7328},
            "engenheiro paulo de frontin": {lat: -22.5511, lon: -43.6789},
            "seropedica": {lat: -22.7444, lon: -43.7086},
            "pira√≠": {lat: -22.6288, lon: -43.8983},
            "barra do pira√≠": {lat: -22.4697, lon: -43.8247},
            "vassouras": {lat: -22.4045, lon: -43.6631},
            "miguel pereira": {lat: -22.4578, lon: -43.4800},
            "paty do alferes": {lat: -22.4300, lon: -43.4242},
            "nova igua√ßu": {lat: -22.7561, lon: -43.4607},
            "queimados": {lat: -22.7153, lon: -43.5558},
            "rio de janeiro": {lat: -22.9068, lon: -43.1729},
            "volta redonda": {lat: -22.5231, lon: -44.1042},
            "itagua√≠": {lat: -22.8696, lon: -43.7758}
        };

        // --- FUN√á√ïES DE DATA E IDADE (NOVA IMPLEMENTA√á√ÉO) ---
        function parseToDate(dataStr) {
            if (!dataStr) return null;
            if (typeof dataStr === 'string' && dataStr.includes('/')) {
                const partes = dataStr.split('/');
                if (partes.length === 3) {
                    return new Date(partes[2], partes[1] - 1, partes[0]);
                }
            }
            const d = new Date(dataStr);
            return isNaN(d.getTime()) ? null : d;
        }

        function calcularIdade(dataStr) {
            const dateObj = parseToDate(dataStr);
            if (!dateObj) return 'N/D';

            const hoje = new Date();
            let idade = hoje.getFullYear() - dateObj.getFullYear();
            const m = hoje.getMonth() - dateObj.getMonth();
            if (m < 0 || (m === 0 && hoje.getDate() < dateObj.getDate())) {
                idade--;
            }
            return idade;
        }

        // --- AUTH ---
        onAuthStateChanged(auth, (user) => {
            document.getElementById('loading-screen').style.display = 'none';
            if (user && ALLOWED_EMAILS.includes(user.email.toLowerCase())) {
                document.getElementById('user-email').innerText = user.email;
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-screen').style.display = 'block';
                window.carregarCandidatos();
            } else if (user) {
                document.getElementById('denied-email').innerText = user.email;
                document.getElementById('access-denied').style.display = 'flex';
                document.getElementById('login-screen').style.display = 'none';
            } else {
                document.getElementById('login-screen').style.display = 'flex';
            }
        });

        window.login = () => signInWithPopup(auth, provider);
        window.logout = () => signOut(auth).then(() => location.reload());

        // --- CRUD ---
        window.carregarCandidatos = async () => {
            const tableBody = document.getElementById('table-body');
            tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px;">Carregando banco de talentos...</td></tr>';
            
            try {
                const snapshot = await get(child(ref(db), 'candidatos'));
                allCandidates = [];
                if (snapshot.exists()) {
                    snapshot.forEach(childSnapshot => {
                        allCandidates.push({
                            id: childSnapshot.key,
                            ...childSnapshot.val()
                        });
                    });
                }
                filteredCandidates = [...allCandidates]; // Inicializa filtrados
                window.aplicarFiltros();
            } catch (error) {
                console.error(error);
                alert("Erro ao carregar: " + error.message);
            }
        };

        window.salvarCandidato = async () => {
            const data = {
                nome: document.getElementById('c_nome').value,
                email: document.getElementById('c_email').value,
                nascimento: document.getElementById('c_nascimento').value,
                cpf: document.getElementById('c_cpf').value,
                telefone: document.getElementById('c_telefone').value,
                whatsapp: document.getElementById('c_whatsapp').value,
                sexo: document.getElementById('c_sexo').value,
                estado_civil: document.getElementById('c_civil').value,
                area: document.getElementById('c_area').value,
                cep: document.getElementById('c_cep').value,
                endereco: document.getElementById('c_endereco').value,
                numero: document.getElementById('c_numero').value,
                complemento: document.getElementById('c_complemento').value,
                bairro: document.getElementById('c_bairro').value,
                cidade: document.getElementById('c_cidade').value,
                estado: document.getElementById('c_estado').value,
                data_cadastro: currentEditId ? (allCandidates.find(c => c.id === currentEditId).data_cadastro) : new Date().toISOString()
            };

            if (!data.nome || !data.area) return alert("Nome e √Årea s√£o obrigat√≥rios!");

            try {
                if (currentEditId) {
                    await update(ref(db, `candidatos/${currentEditId}`), data);
                    alert("Salvo com sucesso!");
                } else {
                    await push(ref(db, 'candidatos'), data);
                    alert("Cadastrado com sucesso!");
                }
                window.closeModal();
                window.carregarCandidatos();
            } catch (e) { alert("Erro: " + e.message); }
        };

        window.deletarCandidato = async (id) => {
            if (confirm("Deseja realmente excluir?")) {
                await remove(ref(db, `candidatos/${id}`));
                window.carregarCandidatos();
            }
        };

        window.editarCandidato = (id) => {
            const c = allCandidates.find(x => x.id === id);
            if (!c) return;
            currentEditId = id;
            document.getElementById('modalTitle').innerHTML = "Editar Candidato";
            
            // Campos que ser√£o preenchidos
            const fields = [
                'nome', 'email', 'nascimento', 'cpf', 'telefone', 'whatsapp', 
                'sexo', 'civil', 'area', 'cep', 'endereco', 'numero', 
                'complemento', 'bairro', 'cidade', 'estado'
            ];

            fields.forEach(f => {
                let key = f;
                if (f === 'civil') key = 'estado_civil'; // Ajuste de nome da chave
                
                // Formata a data DD/MM/YYYY para input date (YYYY-MM-DD) se precisar
                let val = c[key] || '';
                if (f === 'nascimento' && val.includes('/')) {
                     const p = val.split('/');
                     if (p.length === 3) val = `${p[2]}-${p[1]}-${p[0]}`;
                }
                
                document.getElementById(`c_${f}`).value = val;
            });
            window.openModal();
        };

        window.visualizarCandidato = (id) => {
            const c = allCandidates.find(x => x.id === id);
            if (!c) return;
            
            const formatInfo = (label, value) => `
                <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; border: 1px solid #eee;">
                    <strong style="font-size: 0.75rem; color: #888; text-transform: uppercase;">${label}</strong><br>
                    <span style="color: #333; font-size: 0.95rem;">${value || '-'}</span>
                </div>
            `;
            
            let badgeClass = 'badge-area';
            if (c.area === 'Produ√ß√£o') badgeClass = 'badge-prod';
            if (['Administrativo','Financeiro','RH','Comercial'].includes(c.area)) badgeClass = 'badge-adm';
            if (c.area === 'Financeiro') badgeClass = 'badge-fin';

            let idadeCalc = calcularIdade(c.nascimento);
            idadeCalc = idadeCalc === 'N/D' ? 'N/D' : idadeCalc + ' anos';

            const dCad = c.data_cadastro ? new Date(c.data_cadastro).toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit'}) : '-';

            document.getElementById('conteudoVisualizar').innerHTML = `
                <div class="full-width" style="display:flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 15px; margin-bottom: 10px;">
                    <h2 style="margin: 0; color: var(--psr-blue); font-size: 1.4rem;">${c.nome}</h2>
                    <span class="badge ${badgeClass}" style="font-size: 0.9rem; padding: 6px 12px;">${c.area || '-'}</span>
                </div>
                
                ${formatInfo('E-mail', c.email)}
                ${formatInfo('CPF', c.cpf)}
                ${formatInfo('Nascimento', c.nascimento)}
                ${formatInfo('Idade', idadeCalc)}
                ${formatInfo('Telefone', c.telefone)}
                ${formatInfo('WhatsApp', c.whatsapp)}
                ${formatInfo('Sexo', c.sexo)}
                ${formatInfo('Estado Civil', c.estado_civil)}
                
                <div class="full-width" style="margin-top: 10px;"><h4 style="margin: 0; color: #555; border-bottom: 1px solid #ddd; padding-bottom: 5px;">Endere√ßo</h4></div>
                
                ${formatInfo('CEP', c.cep)}
                ${formatInfo('Endere√ßo', c.endereco + (c.numero ? ', n¬∫ ' + c.numero : ''))}
                ${formatInfo('Complemento', c.complemento)}
                ${formatInfo('Bairro', c.bairro)}
                ${formatInfo('Cidade', c.cidade)}
                ${formatInfo('Estado (UF)', c.estado)}
                
                <div class="full-width" style="margin-top: 10px; display: flex; justify-content: space-between; align-items: center; background: #e3f2fd; padding: 10px 15px; border-radius: 8px;">
                    <span style="font-size: 0.85rem; color: #0d47a1;"><strong>Registrado em:</strong> ${dCad}</span>
                </div>
            `;
            document.getElementById('modalVisualizar').style.display = 'flex';
        };

        // --- ORDENA√á√ÉO (SORTING) ---
        window.sortBy = (key) => {
            if (sortConfig.key === key) {
                sortConfig.direction = sortConfig.direction === 'asc' ? 'desc' : 'asc';
            } else {
                sortConfig.key = key;
                sortConfig.direction = 'asc';
            }
            
            document.querySelectorAll('th').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
                const icon = th.querySelector('i');
                if (icon) {
                    icon.className = 'fas fa-sort'; 
                }
            });
            
            const currentTh = document.querySelector(`th[onclick="sortBy('${key}')"]`);
            if(currentTh) {
                currentTh.classList.add(sortConfig.direction === 'asc' ? 'sort-asc' : 'sort-desc');
                currentTh.querySelector('i').className = sortConfig.direction === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down';
            }

            filteredCandidates.sort((a, b) => {
                if (key === 'nascimento') {
                    // Ordena pela data exata
                    const dateA = parseToDate(a.nascimento);
                    const dateB = parseToDate(b.nascimento);
                    const timeA = dateA ? dateA.getTime() : 0;
                    const timeB = dateB ? dateB.getTime() : 0;
                    return sortConfig.direction === 'asc' ? timeB - timeA : timeA - timeB;
                }

                let valA = a[key] ? a[key].toString().toLowerCase() : '';
                let valB = b[key] ? b[key].toString().toLowerCase() : '';

                if (valA < valB) return sortConfig.direction === 'asc' ? -1 : 1;
                if (valA > valB) return sortConfig.direction === 'asc' ? 1 : -1;
                return 0;
            });

            renderTable(filteredCandidates);
        };

        // --- FILTROS INTELIGENTES ---

        function levenshtein(a, b) {
            const matrix = [];
            for (let i = 0; i <= b.length; i++) matrix[i] = [i];
            for (let j = 0; j <= a.length; j++) matrix[0][j] = j;
            for (let i = 1; i <= b.length; i++) {
                for (let j = 1; j <= a.length; j++) {
                    if (b.charAt(i - 1) == a.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(matrix[i - 1][j - 1] + 1, Math.min(matrix[i][j - 1] + 1, matrix[i - 1][j] + 1));
                    }
                }
            }
            return matrix[b.length][a.length];
        }

        function isFuzzyMatch(textoInput, textoBanco) {
            if (!textoInput) return true;
            
            const safeBanco = String(textoBanco || "");
            if (safeBanco.trim() === "") return false;
            
            const a = textoInput.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
            const b = safeBanco.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();

            if (b.includes(a)) return true;
            const maxErrors = Math.floor(a.length / 4) + 1; 
            const dist = levenshtein(a, b);
            return dist <= maxErrors; 
        }

        function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
            var R = 6371; 
            var dLat = deg2rad(lat2 - lat1);
            var dLon = deg2rad(lon2 - lon1);
            var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; 
        }
        function deg2rad(deg) { return deg * (Math.PI / 180); }

        window.aplicarFiltros = () => {
            const btnFilter = document.querySelector('.btn-filter');
            btnFilter.innerText = "Filtrando...";
            
            setTimeout(() => {
                const fNome = document.getElementById('f_nome').value;
                const fArea = document.getElementById('f_area').value;
                const fCidade = document.getElementById('f_cidade').value;
                const fBairro = document.getElementById('f_bairro').value;
                
                const fIdadeMin = parseInt(document.getElementById('f_idade_min').value) || 0;
                const fIdadeMax = parseInt(document.getElementById('f_idade_max').value) || 100;
                
                // Geo
                const fGeoRef = document.getElementById('f_geo_ref').value.toLowerCase().trim();
                const fGeoRaio = parseFloat(document.getElementById('f_geo_km').value) || 0;
                let coordsRef = (fGeoRef && CITY_COORDS[fGeoRef]) ? CITY_COORDS[fGeoRef] : null;

                filteredCandidates = allCandidates.filter(c => {
                    const matchNome = isFuzzyMatch(fNome, c.nome);
                    const matchArea = fArea === "" || c.area === fArea;
                    const matchCidade = isFuzzyMatch(fCidade, c.cidade);
                    const matchBairro = isFuzzyMatch(fBairro, c.bairro);

                    // Corrige o filtro de idade
                    let idadeNum = calcularIdade(c.nascimento);
                    if (idadeNum === 'N/D') idadeNum = 0;
                    const matchIdade = idadeNum >= fIdadeMin && idadeNum <= fIdadeMax;

                    let matchGeo = true;
                    if (fGeoRaio > 0 && fGeoRef) {
                        const candCityNorm = (c.cidade || "").toLowerCase().trim();
                        if (candCityNorm && CITY_COORDS[candCityNorm] && coordsRef) {
                            const coordsCand = CITY_COORDS[candCityNorm];
                            const dist = getDistanceFromLatLonInKm(coordsRef.lat, coordsRef.lon, coordsCand.lat, coordsCand.lon);
                            c.distanciaCalculada = dist.toFixed(1);
                            if (dist > fGeoRaio) matchGeo = false;
                        } else if (!isFuzzyMatch(fGeoRef, candCityNorm)) {
                            matchGeo = false;
                        }
                    } else {
                        c.distanciaCalculada = null;
                    }

                    return matchNome && matchArea && matchCidade && matchBairro && matchGeo && matchIdade;
                });

                if (sortConfig.key) {
                    window.sortBy(sortConfig.key); 
                } else {
                    renderTable(filteredCandidates);
                }
                
                btnFilter.innerText = "Aplicar Filtros";
            }, 50);
        };

        function renderTable(list) {
            const tbody = document.getElementById('table-body');
            document.getElementById('total-count').innerText = list.length;
            tbody.innerHTML = "";

            if (list.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:30px; color:#888;">Nenhum candidato encontrado.</td></tr>';
                return;
            }

            list.forEach(c => {
                // C√°lculo de idade arrumado exibido na tabela
                let idadeCalculada = calcularIdade(c.nascimento);
                let idadeExibir = idadeCalculada === 'N/D' ? 'N/D' : idadeCalculada + ' anos';
                
                let badgeClass = 'badge-area';
                if (c.area === 'Produ√ß√£o') badgeClass = 'badge-prod';
                if (['Administrativo','Financeiro','RH','Comercial'].includes(c.area)) badgeClass = 'badge-adm';
                if (c.area === 'Financeiro') badgeClass = 'badge-fin';

                // --- SHAREPOINT ---
                let btnLink = `<span style="color:#eee; cursor:default" title="Aguardando arquivo..."><i class="fas fa-clock"></i></span>`;
                
                if (c.link_cv) {
                    btnLink = `<a href="${c.link_cv}" target="_blank" class="btn-icon" style="color:#d93025; font-size:1.2rem" title="Abrir Curr√≠culo Direto (PDF/DOC)"><i class="fas fa-file-pdf"></i></a>`;
                } else {
                    const termoBusca = c.cpf || c.nome; 
                    const baseUrl = "https://psrimpresssao.sharepoint.com/sites/GenteeGestao/Documentos%20Compartilhados/Forms/AllItems.aspx";
                    const folderPath = "/sites/GenteeGestao/Documentos Compartilhados/RH/Curr√≠culos Site";
                    const linkBusca = `${baseUrl}?id=${encodeURIComponent(folderPath)}&viewid=0&q=${encodeURIComponent(termoBusca)}`;
                    
                    btnLink = `<a href="${linkBusca}" target="_blank" class="btn-icon" style="color:#0078d4" title="Procurar arquivo na pasta"><i class="fas fa-search"></i></a>`;
                }

                const wpp = c.whatsapp ? c.whatsapp.replace(/\D/g, '') : '';
                const btnWpp = wpp ? `<a href="https://wa.me/55${wpp}" target="_blank" class="btn-icon" style="color:#25d366"><i class="fab fa-whatsapp"></i></a>` : `<span class="btn-icon" style="color:#eee"><i class="fab fa-whatsapp"></i></span>`;

                let localHtml = `${c.cidade || '-'} / ${c.bairro || '-'}`;
                if (c.distanciaCalculada) {
                    localHtml += `<span class="dist-badge"><i class="fas fa-map-marker-alt"></i> ${c.distanciaCalculada}km</span>`;
                }

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <div style="font-weight:600; color:var(--psr-blue)">${c.nome}</div>
                        <div style="font-size:0.75rem; color:#888">${c.email || ''}</div>
                    </td>
                    <td><span class="badge ${badgeClass}">${c.area}</span></td>
                    <td>${idadeExibir}</td>
                    <td>${localHtml}</td>
                    <td>${c.telefone || '-'}</td>
                    <td class="actions-cell">
                        ${btnWpp}
                        ${btnLink}
                        <button onclick="visualizarCandidato('${c.id}')" class="btn-icon" title="Visualizar Detalhes"><i class="fas fa-eye"></i></button>
                        <button onclick="editarCandidato('${c.id}')" class="btn-icon" title="Editar"><i class="fas fa-edit"></i></button>
                        <button onclick="deletarCandidato('${c.id}')" class="btn-icon delete" title="Excluir"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- UI ---
        window.openModal = () => document.getElementById('modalCandidato').style.display = 'flex';
        
        window.closeModal = () => {
            document.getElementById('modalCandidato').style.display = 'none';
            currentEditId = null;
            document.getElementById('formCandidato').reset();
            document.getElementById('modalTitle').innerText = "Novo Candidato";
        }
        
        window.closeModalVisualizar = () => {
            document.getElementById('modalVisualizar').style.display = 'none';
        }

        window.limparFiltros = () => {
            document.querySelectorAll('.filter-input').forEach(el => el.value = '');
            window.aplicarFiltros();
        }

    </script>
</head>
<body>

    <div id="loading-screen" class="full-screen">
        <i class="fas fa-spinner fa-spin fa-3x" style="color:var(--psr-blue)"></i>
        <p style="margin-top:15px">Acessando Banco de Talentos...</p>
    </div>

    <div id="login-screen" class="full-screen">
        <div class="auth-card">
            <h2>PSR Talentos</h2>
            <p>Acesso Restrito ao RH</p>
            <button onclick="login()" class="btn-google">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20"> Entrar com Google
            </button>
        </div>
    </div>

    <div id="access-denied" class="full-screen">
        <div class="auth-card" style="border-top: 5px solid red;">
            <h2 style="color:red">Acesso Negado</h2>
            <p>O e-mail <b id="denied-email"></b> n√£o tem permiss√£o.</p>
            <button onclick="logout()" class="btn-google" style="border:1px solid red; color:red">Sair</button>
        </div>
    </div>

    <div id="app-screen">
        <header>
            <div class="logo">
                <h1>Banco de Talentos <i class="fas fa-brain" style="color:var(--psr-accent); font-size:0.9rem"></i></h1>
                <span>PSR Impress√£o</span>
            </div>
            <div style="display:flex; align-items:center; gap:15px">
                <span id="user-email" style="font-size:0.8rem">...</span>
                <button onclick="logout()" style="background:none; border:none; color:white; cursor:pointer"><i class="fas fa-sign-out-alt"></i> Sair</button>
            </div>
        </header>

        <div class="main-container">
            <aside class="sidebar">
                <h3><i class="fas fa-filter"></i> Filtros</h3>
                
                <div class="filter-group">
                    <label>Nome do Candidato</label>
                    <input type="text" id="f_nome" class="filter-input" placeholder="Ex: Joa da Silva">
                </div>

                <div class="filter-group">
                    <label>√Årea Pretendida</label>
                    <select id="f_area" class="filter-input">
                        <option value="">Todas</option>
                        <option value="Produ√ß√£o">Produ√ß√£o</option>
                        <option value="Administra√ß√£o">Administra√ß√£o</option>
                        <option value="RH">RH</option>
                        <option value="Financeiro">Financeiro</option>
                        <option value="Comercial">Comercial</option>
                        <option value="Log√≠stica">Log√≠stica</option>
                        <option value="TI">TI</option>
                        <option value="Operacional">Operacional</option>
                        <option value="Marketing">Marketing</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label>Idade</label>
                    <div style="display:flex; gap:5px; align-items:center;">
                        <input type="number" id="f_idade_min" class="filter-input" placeholder="Min" style="width:48%">
                        <span>-</span>
                        <input type="number" id="f_idade_max" class="filter-input" placeholder="Max" style="width:48%">
                    </div>
                </div>

                <div class="filter-group geo-group">
                    <label><i class="fas fa-map-marked-alt"></i> Busca Inteligente (KM)</label>
                    <input type="text" id="f_geo_ref" class="filter-input" placeholder="Refer√™ncia (Ex: Paracambi)" style="margin-bottom:5px">
                    <div style="display:flex; align-items:center; gap:5px">
                        <input type="number" id="f_geo_km" class="filter-input" placeholder="Raio (km)">
                        <span style="font-size:0.8rem; color:#666">km</span>
                    </div>
                </div>

                <div class="filter-group">
                    <label>Cidade</label>
                    <input type="text" id="f_cidade" class="filter-input" placeholder="Ex: Paracambi">
                </div>

                <div class="filter-group">
                    <label>Bairro</label>
                    <input type="text" id="f_bairro" class="filter-input" placeholder="Ex: Centro">
                </div>

                <button class="btn-filter" onclick="aplicarFiltros()">Aplicar Filtros</button>
                <button class="btn-filter btn-clear" onclick="limparFiltros()">Limpar</button>
            </aside>

            <main>
                <div class="top-bar">
                    <div class="stats">
                        Candidatos Vis√≠veis: <strong id="total-count">0</strong>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button class="btn-add" style="background-color: var(--psr-blue);" onclick="carregarCandidatos()">
                            <i class="fas fa-sync-alt"></i> Atualizar
                        </button>
                        <button class="btn-add" onclick="openModal()">
                            <i class="fas fa-plus"></i> Novo Candidato
                        </button>
                    </div>

                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th onclick="sortBy('nome')">Candidato <i class="fas fa-sort"></i></th>
                                <th onclick="sortBy('area')">√Årea <i class="fas fa-sort"></i></th>
                                <th onclick="sortBy('nascimento')">Idade <i class="fas fa-sort"></i></th>
                                <th onclick="sortBy('cidade')">Localiza√ß√£o <i class="fas fa-sort"></i></th>
                                <th onclick="sortBy('telefone')">Telefone <i class="fas fa-sort"></i></th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="table-body">
                            </tbody>
                    </table>
                </div>
            </main>
        </div>
    </div>

    <div id="modalCandidato" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <h3 id="modalTitle" style="color:var(--psr-blue); margin:0">Novo Candidato</h3>
                <button onclick="closeModal()" style="border:none; background:none; cursor:pointer; font-size:1.2rem">&times;</button>
            </div>
            
            <form id="formCandidato" onsubmit="event.preventDefault(); salvarCandidato();">
                <div class="modal-grid">
                    <div class="form-group full-width">
                        <label>Nome Completo *</label>
                        <input type="text" id="c_nome" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Email (Gera o link do CV)</label>
                        <input type="email" id="c_email">
                    </div>
                    <div class="form-group">
                        <label>Data Nascimento</label>
                        <input type="date" id="c_nascimento">
                    </div>

                    <div class="form-group">
                        <label>CPF</label>
                        <input type="text" id="c_cpf">
                    </div>
                    <div class="form-group">
                        <label>Telefone</label>
                        <input type="text" id="c_telefone">
                    </div>
                    
                    <div class="form-group">
                        <label>WhatsApp</label>
                        <input type="text" id="c_whatsapp">
                    </div>
                    <div class="form-group">
                        <label>√Årea Pretendida *</label>
                        <select id="c_area" required>
                            <option value="">Selecione...</option>
                            <option value="Produ√ß√£o">Produ√ß√£o</option>
                            <option value="Administra√ß√£o">Administra√ß√£o</option>
                            <option value="RH">RH</option>
                            <option value="Financeiro">Financeiro</option>
                            <option value="Comercial">Comercial</option>
                            <option value="Log√≠stica">Log√≠stica</option>
                            <option value="TI">TI</option>
                            <option value="Operacional">Operacional</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Sexo</label>
                        <select id="c_sexo">
                            <option value="">Selecione...</option>
                            <option value="Masculino">Masculino</option>
                            <option value="Feminino">Feminino</option>
                            <option value="Outro">Outro</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Estado Civil</label>
                        <input type="text" id="c_civil">
                    </div>

                    <div class="form-group">
                        <label>CEP</label>
                        <input type="text" id="c_cep">
                    </div>
                    <div class="form-group">
                        <label>Endere√ßo (Rua)</label>
                        <input type="text" id="c_endereco">
                    </div>
                    <div class="form-group">
                        <label>N√∫mero</label>
                        <input type="text" id="c_numero">
                    </div>
                    <div class="form-group">
                        <label>Complemento</label>
                        <input type="text" id="c_complemento">
                    </div>
                    <div class="form-group">
                        <label>Bairro</label>
                        <input type="text" id="c_bairro">
                    </div>
                    <div class="form-group">
                        <label>Cidade</label>
                        <input type="text" id="c_cidade">
                    </div>
                    <div class="form-group">
                        <label>Estado (UF)</label>
                        <input type="text" id="c_estado" maxlength="2" style="text-transform:uppercase">
                    </div>
                </div>

                <div style="margin-top:20px; display:flex; gap:10px; justify-content:flex-end">
                    <button type="button" onclick="closeModal()" style="padding:10px 20px; border:none; background:#eee; cursor:pointer; border-radius:6px">Cancelar</button>
                    <button type="submit" style="padding:10px 20px; border:none; background:var(--psr-blue); color:white; cursor:pointer; border-radius:6px">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modalVisualizar" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <h3 style="color:var(--psr-blue); margin:0"><i class="fas fa-id-card"></i> Detalhes do Candidato</h3>
                <button onclick="closeModalVisualizar()" style="border:none; background:none; cursor:pointer; font-size:1.2rem">&times;</button>
            </div>
            
            <div id="conteudoVisualizar" class="modal-grid">
                </div>

            <div style="margin-top:20px; display:flex; justify-content:flex-end">
                <button type="button" onclick="closeModalVisualizar()" style="padding:10px 20px; border:none; background:var(--psr-blue); color:white; cursor:pointer; border-radius:6px">Fechar</button>
            </div>
        </div>
    </div>

</body>
</html>
